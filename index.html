<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campus Connect</title>
  <link rel="icon" href="CAMPUS CONNECT.jpg" />
  <style>
    /* === Reset & base to match original upload === */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      background: #f2f4f8;
      color: #0b3a1f;
      padding: 22px;
    }

    .center-wrap {
      max-width: 980px;
      margin: 0 auto;
    }

    /* === Header (original look) === */
    header.app-header {
      background: #18ab91;
      color: #fff;
      padding: 18px;
      border-radius: 12px;
      text-align: center;
      position: relative;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      margin-bottom: 18px;
    }

    header.app-header img {
      height: 72px;
      display: block;
      margin: 0 auto 6px
    }

    header.app-header h1 {
      font-size: 24px;
      margin-bottom: 4px
    }

    header.app-header p {
      margin: 0;
      opacity: .95
    }

    /* small circular profile buttons (kept original IDs) */
    .profile-btn {
      position: absolute;
      right: 18px;
      top: 18px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #fff;
      color: #18ab91;
      border: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08)
    }

    /* === Original animated login/signup container (restored) === */
    .auth-area {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 12px 0;
    }

    .auth-box {
      width: 100%;
      max-width: 900px;
      height: 540px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08)
    }

    .form-panel {
      position: absolute;
      top: 0;
      height: 100%;
      transition: all .6s ease-in-out
    }

    .sign-in-panel {
      left: 0;
      width: 50%;
      z-index: 2
    }

    .sign-up-panel {
      left: 0;
      width: 50%;
      opacity: 0;
      z-index: 1
    }

    form {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0 50px;
      text-align: center
    }

    form h1 {
      color: #18ab91;
      margin-bottom: 12px
    }

    input,
    select {
      width: 100%;
      max-width: 340px;
      padding: 12px 14px;
      border-radius: 8px;
      border: 0;
      background: #f0f1f3;
      margin: 8px 0
    }

    button.btn {
      padding: 12px 36px;
      border-radius: 999px;
      border: 0;
      background: #18ab91;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px
    }

    button.ghost {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.35);
      color: #fff;
      padding: 10px 26px;
      border-radius: 8px;
      cursor: pointer
    }

    .overlay-outer {
      position: absolute;
      top: 0;
      left: 50%;
      width: 50%;
      height: 100%;
      overflow: hidden;
      transition: transform .6s ease-in-out;
      z-index: 100
    }

    .overlay {
      position: relative;
      left: -100%;
      width: 200%;
      height: 100%;
      display: flex;
      align-items: center;
      transition: transform .6s ease-in-out;
      background: linear-gradient(90deg, #20b39a 0%, #17a88a 100%);
      color: #fff
    }

    .overlay-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 40px;
      text-align: center
    }

    .auth-box.right-panel-active .sign-in-panel {
      transform: translateX(100%);
      opacity: 0
    }

    .auth-box.right-panel-active .sign-up-panel {
      transform: translateX(100%);
      opacity: 1;
      z-index: 6
    }

    .auth-box.right-panel-active .overlay-outer {
      transform: translateX(-100%)
    }

    .auth-box.right-panel-active .overlay {
      transform: translateX(50%)
    }

    /* === Student dashboard (the only intentional change) === */
    .student-hero {
      text-align: center;
      margin: 22px 0
    }

    .student-hero h2 {
      font-size: 60px;
      color: #188f47;
      font-weight: 800;
      margin: 0;
      line-height: 1
    }

    .nav-bar {
      display: flex;
      justify-content: center;
      background: #188f47;
      padding: 12px;
      border-radius: 10px;
      gap: 12px;
      color: #fff;
      box-shadow: 0 6px 0 rgba(24, 139, 86, 0.06)
    }

    .nav-item {
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      color: #fff;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 10px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 180px;
      background: #fff;
      border-radius: 8px;
      padding: 6px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      display: none
    }

    .dropdown-menu.show {
      display: block
    }

    .dropdown-menu a {
      display: block;
      padding: 9px 12px;
      color: #16643a;
      text-decoration: none;
      font-weight: 700
    }

    .dropdown-menu a:hover {
      background: #188f47;
      color: #fff;
      border-radius: 6px
    }

    .notice-box {
      border: 3px solid #16733f;
      border-radius: 12px;
      padding: 16px;
      background: #fff;
      min-height: 260px;
      overflow: auto
    }

    .notice-card {
      padding: 12px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.04);
      margin-bottom: 10px
    }

    .notice-attach {
      margin-left: auto;
      color: #18ab91;
      text-decoration: none;
      font-weight: 700
    }

    /* === Admin / HOD (original) === */
    .chat-btn {
      display: inline-block;
      padding: 10px 14px;
      border: 2px solid #18ab91;
      border-radius: 8px;
      color: #18ab91;
      text-decoration: none;
      margin: 6px 0
    }

    .logout-btn {
      background: #18ab91;
      color: #fff;
      border: 0;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer
    }

    /* === Modals === */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999
    }

    .modal .box {
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      width: 90%;
      max-width: 480px
    }

    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000
    }

    .profile-modal .box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 420px
    }

    @media (max-width:900px) {
      .overlay-outer {
        display: none
      }

      .sign-in-panel,
      .sign-up-panel {
        position: relative;
        width: 100%;
        left: 0;
        transform: none;
        opacity: 1
      }
    }
  </style>
</head>

<body>
  <div class="center-wrap">
    <header class="app-header">
      <img src="CAMPUS CONNECT.jpg" alt="logo">
      <h1>Campus Connect</h1>
      <p>Unite Your Campus</p>
      <!-- profile buttons shown/hidden in JS -->
      <button id="profileBtn" class="profile-btn" style="display:none">👤</button>
      <button id="profileBtn2" class="profile-btn" style="display:none;right:72px">👤</button>
    </header>

    <!-- === Auth area (original) === -->
    <div class="auth-area" id="authArea">
      <div class="auth-box auth-box auth-box" id="authBox">
        <div class="form-panel sign-up-panel">
          <form id="signupForm">
            <h1>Create Account</h1>
            <input id="signupName" type="text" placeholder="Name" required>
            <input id="signupEmail" type="email" placeholder="Email" required>
            <input id="signupPassword" type="password" placeholder="Password" required>
            <select id="signupRole" required>
              <option value="" disabled selected>Select role</option>
              <option value="student">Student</option>
              <option value="faculty">Faculty</option>
              <option value="hod">HOD / Admin</option>
            </select>
            <button class="btn" type="submit">Sign Up</button>
          </form>
        </div>

        <div class="form-panel sign-in-panel">
          <form id="loginForm">
            <h1>Sign In</h1>
            <input id="loginEmail" type="email" placeholder="Email" required>
            <input id="loginPassword" type="password" placeholder="Password" required>
            <button class="btn" type="submit">Login</button>
          </form>
        </div>

        <div class="overlay-outer">
          <div class="overlay">
            <div class="overlay-panel">
              <h1>Welcome Back!</h1>
              <p>Login with your account</p>
              <button class="ghost" id="toggleSignIn">Sign In</button>
            </div>
            <div class="overlay-panel">
              <h1>Hello!</h1>
              <p>Enter your details and start your journey</p>
              <button class="ghost" id="toggleSignUp">Sign Up</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- === Faculty / HOD view (original UI) === -->
    <section id="facultyView" style="display:none;margin-top:12px">
      <h2 style="color:#16733f;margin-bottom:10px">Admin / HOD</h2>
      <div>
        <h3>Pending Signups</h3>
        <table id="pendingTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="margin-top:12px">
        <h3>Chat Options</h3>
        <div>
          <a class="chat-btn" href="chat.html" target="_blank">🌐 Global Chat</a>
          <a class="chat-btn" href="private.html" target="_blank">💬 Private Chat</a>
          <a class="chat-btn" href="groups.html" target="_blank">👥 Groups</a>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="openNoticeModal" class="chat-btn">📁 Send Notice</button>
        <h3 style="margin-top:12px">Sent Notices</h3>
        <div id="sentNotices"></div>
      </div>

      <div style="margin-top:12px">
        <button id="logoutBtnFaculty" class="logout-btn">Logout</button>
      </div>
    </section>

    <!-- === Student dashboard (only changed area) === -->
    <section id="studentView" style="display:none;margin-top:12px">
      <div class="student-hero">
        <h2>Student Dashboard</h2>
      </div>

      <nav class="nav-bar" role="navigation">
        <div class="nav-item" id="chatPill" tabindex="0" aria-haspopup="true" aria-expanded="false">
          Chat Option
          <div class="dropdown-menu" id="chatDropdown">
            <a href="chat.html" target="_blank">Global Chat</a>
            <a href="private.html" target="_blank">Private Chat</a>
            <a href="groups.html" target="_blank">Group Chat</a>
          </div>
        </div>

        <a class="nav-item" id="classRoomPill" href="classroom.html">Class Room</a>

        <div class="nav-item" id="schedulePill">Schedule</div>

        <div class="nav-item" id="testPill" tabindex="0" aria-haspopup="true" aria-expanded="false">
          Test and Result
          <div class="dropdown-menu" id="testDropdown">
            <a href="test.html" target="_blank">Tests</a>
            <a href="student.html" target="_blank">Results</a>
          </div>
        </div>
      </nav>

      <div style="margin-top:16px">
        <h3 style="color:#16733f">Notices</h3>
        <div class="notice-box" id="studentNotices"></div>
      </div>

      <div style="margin-top:14px">
        <button id="logoutBtnStudent" class="logout-btn">Logout</button>
      </div>
    </section>

    <!-- === Notice Modal (original) === -->
    <div id="noticeModal" class="modal" aria-hidden="true">
      <div class="box">
        <h3>Send Notice</h3>
        <input type="text" id="noticeTitle" placeholder="Notice title">
        <textarea id="noticeMsg" rows="4" placeholder="Notice message"></textarea>
        <select id="noticeTarget">
          <option value="both">Students & Faculty</option>
          <option value="students">Students Only</option>
          <option value="faculty">Faculty Only</option>
        </select>
        <input type="file" id="noticeFile" accept=".pdf,image/*">
        <div style="text-align:right;margin-top:10px">
          <button id="sendNoticeBtn" class="btn">Send Notice</button>
          <button id="closeNoticeModal" class="btn" style="background:#ccc;color:#000;margin-left:8px">Cancel</button>
        </div>
      </div>
    </div>

    <!-- === Profile modal (original) === -->
    <div id="profileModal" class="profile-modal" aria-hidden="true">
      <div class="box">
        <h3>Your Profile</h3>
        <label>Name</label>
        <input id="profName" type="text">
        <label>Email</label>
        <input id="profEmail" type="email" disabled>
        <label>Role</label>
        <input id="profRole" type="text" disabled>
        <label>Bio</label>
        <textarea id="profBio" rows="3"></textarea>
        <label>Profile Image</label>
        <input id="profImage" type="file" accept="image/*">
        <div style="text-align:right;margin-top:10px">
          <button id="saveProfile" class="btn">Save</button>
          <button id="closeProfile" class="btn" style="background:#ccc;color:#000;margin-left:8px">Close</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import {
      auth, db, storage,
      signOut, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sRef, uploadBytesResumable, getDownloadURL
    } from "./server.js";
    import { onAuthStateChanged } from "./server.js";

    /* === Overlay toggles (renamed to avoid conflict) === */
    const authBox = document.querySelector('.auth-box');
    const toggleSignUp = document.getElementById('toggleSignUp');
    const toggleSignIn = document.getElementById('toggleSignIn');
    if (toggleSignUp) toggleSignUp.onclick = () => authBox.classList.add('right-panel-active');
    if (toggleSignIn) toggleSignIn.onclick = () => authBox.classList.remove('right-panel-active');

    /* === Helper: show/hide main views === */
    function showView(id) {
      document.getElementById('authArea').style.display = (id === 'auth') ? 'flex' : 'none';
      document.getElementById('studentView').style.display = (id === 'student') ? 'block' : 'none';
      document.getElementById('facultyView').style.display = (id === 'faculty') ? 'block' : 'none';
      // show/hide header profile buttons
      document.getElementById('profileBtn').style.display = (id === 'faculty') ? 'inline-flex' : 'none';
      document.getElementById('profileBtn2').style.display = (id === 'student') ? 'inline-flex' : 'none';
    }

    /* === Signup handler === */
    document.getElementById('signupForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const name = document.getElementById('signupName').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const pass = document.getElementById('signupPassword').value;
        const role = document.getElementById('signupRole').value;
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, 'users', cred.user.uid), { name, email, role, approved: false, uid: cred.user.uid, createdAt: serverTimestamp() });
        alert('✅ Account created! Awaiting admin approval.');
        await signOut(auth);
      } catch (err) { console.error(err); alert('Signup failed: ' + (err.message || err.code)) }
    });

    /* === Login handler === */
    document.getElementById('loginForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const email = document.getElementById('loginEmail').value.trim();
        const pass = document.getElementById('loginPassword').value;
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) { console.error(err); alert('Login failed: ' + (err.message || err.code)) }
    });

    /* === Auth state === */
    onAuthStateChanged(auth, async user => {
      try {
        if (!user) { showView('auth'); return; }
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (!snap.exists()) { showView('auth'); return; }
        const p = snap.data();
        if (!p.approved) { alert('Waiting for admin approval'); await signOut(auth); return; }
        if (p.role === 'hod' || p.role === 'admin') { showView('faculty'); loadPending(); loadSentNotices(); }
        else if (p.role === 'faculty') { window.location.href = 'faculty_dashboard.html'; }
        else { showView('student'); }
      } catch (err) { console.error(err); showView('auth') }
    });

    /* === Pending approvals for admin === */
    function loadPending() {
      const tbody = document.querySelector('#pendingTable tbody');
      const q = query(collection(db, 'users'), where('approved', '==', false));
      onSnapshot(q, snap => {
        tbody.innerHTML = '';
        snap.forEach(d => {
          const u = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.email}</td><td>${u.role}</td><td>${u.approved ? 'Approved' : 'Pending'}</td><td><button data-id="${u.uid}">Approve</button></td>`;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button').forEach(btn => {
          btn.onclick = async e => { await updateDoc(doc(db, 'users', e.target.dataset.id), { approved: true }); alert('✅ User approved') }
        });
      });
    }

    /* === Notices: send & load === */
    const noticeModal = document.getElementById('noticeModal');
    document.getElementById('openNoticeModal')?.addEventListener('click', () => noticeModal.style.display = 'flex');
    document.getElementById('closeNoticeModal')?.addEventListener('click', () => noticeModal.style.display = 'none');

    document.getElementById('sendNoticeBtn')?.addEventListener('click', async () => {
      try {
        const title = document.getElementById('noticeTitle').value.trim();
        const message = document.getElementById('noticeMsg').value.trim();
        const target = document.getElementById('noticeTarget').value;
        const file = document.getElementById('noticeFile').files[0];
        if (!title || !message) return alert('Fill all fields');
        let fileURL = '', fileName = '';
        if (file) {
          if (!file.type.includes('pdf') && !file.type.includes('image')) return alert('Only PDF or Images allowed');
          const ref = sRef(storage, 'notices/' + Date.now() + '_' + file.name);
          await uploadBytesResumable(ref, file);
          fileURL = await getDownloadURL(ref);
          fileName = file.name;
        }
        await addDoc(collection(db, 'notices'), { title, message, target, fileURL, fileName, sender: auth.currentUser.email, createdAt: serverTimestamp() });
        alert('✅ Notice sent successfully!');
        noticeModal.style.display = 'none';
      } catch (err) { console.error(err); alert('Notice failed: ' + err.message) }
    });

    function loadSentNotices() {
      const list = document.getElementById('sentNotices');
      if (!list) return;
      const q = query(collection(db, 'notices'), where('sender', '==', auth.currentUser.email), orderBy('createdAt', 'desc'));
      onSnapshot(q, snap => {
        list.innerHTML = '';
        snap.forEach(d => {
          const n = d.data();
          const div = document.createElement('div');
          div.className = 'notice-card';
          div.innerHTML = `<strong>${n.title}</strong><div>${n.message}</div>${n.fileURL ? `<div><a href="${n.fileURL}" target="_blank">📎 ${n.fileName}</a></div>` : ''}<div style="font-size:12px;color:#666">${n.createdAt?.toDate?.()?.toLocaleString?.() || ''} | ${n.target}</div>`;
          list.appendChild(div);
        });
      });
    }

    /* === Student notices feed === */
    const studentNotices = document.getElementById('studentNotices');
    if (studentNotices) {
      const q = query(collection(db, 'notices'), orderBy('createdAt', 'desc'));
      onSnapshot(q, snap => {
        studentNotices.innerHTML = '';
        snap.forEach(d => {
          const n = d.data();
          if (n.target === 'students' || n.target === 'both') {
            const div = document.createElement('div');
            div.className = 'notice-card';
            div.innerHTML = `<strong>${n.title}</strong><p>${n.message}</p><div style="display:flex;align-items:center;gap:8px;margin-top:8px;"><small style="color:#666">${n.createdAt?.toDate?.()?.toLocaleString?.() || ''}</small>${n.fileURL ? `<a class="notice-attach" href="${n.fileURL}" target="_blank">📎 ${n.fileName}</a>` : ''}</div>`;
            studentNotices.appendChild(div);
          }
        });
      });
    }

    /* === Logout handlers === */
    document.getElementById('logoutBtnFaculty')?.addEventListener('click', async () => { await signOut(auth); location.reload(); });
    document.getElementById('logoutBtnStudent')?.addEventListener('click', async () => { await signOut(auth); location.reload(); });

    /* === Profile modal handling === */
    const profileModal = document.getElementById('profileModal');
    const profileBtns = [document.getElementById('profileBtn'), document.getElementById('profileBtn2')];
    const closeProfile = document.getElementById('closeProfile');
    const profName = document.getElementById('profName'), profEmail = document.getElementById('profEmail'), profRole = document.getElementById('profRole'), profBio = document.getElementById('profBio'), profImage = document.getElementById('profImage');
    const saveProfile = document.getElementById('saveProfile');

    profileBtns.forEach(btn => {
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          if (!auth.currentUser) return alert('Not logged in');
          const snap = await getDoc(doc(db, 'users', auth.currentUser.uid));
          const p = snap.exists() ? snap.data() : {};
          profName.value = p.name || '';
          profEmail.value = p.email || auth.currentUser.email || '';
          profRole.value = p.role || '';
          profBio.value = p.bio || '';
          profImage.value = '';
          profileModal.style.display = 'flex';
        } catch (err) { console.error(err); alert('Failed to load profile') }
      });
    });

    closeProfile?.addEventListener('click', () => profileModal.style.display = 'none');

    saveProfile?.addEventListener('click', async () => {
      try {
        if (!auth.currentUser) return alert('Not logged in');
        const uid = auth.currentUser.uid;
        const name = profName.value.trim(), bio = profBio.value.trim();
        let photoURL = null;
        const file = profImage.files[0];
        if (file) {
          const ref = sRef(storage, 'profiles/' + uid + '_' + file.name);
          const up = await uploadBytesResumable(ref, file);
          photoURL = await getDownloadURL(up.ref);
        }
        const payload = { name, bio, updatedAt: new Date() };
        if (photoURL) payload.photoURL = photoURL;
        await updateDoc(doc(db, 'users', uid), payload);
        alert('✅ Profile updated!');
        profileModal.style.display = 'none';
      } catch (err) { console.error(err); alert('Failed to save profile: ' + (err.message || err)) }
    });

    /* === Dropdowns for chat/test (student) === */
    (function () {
      const toggles = [{ pill: 'chatPill', menu: 'chatDropdown' }, { pill: 'testPill', menu: 'testDropdown' }];
      function closeAll() { toggles.forEach(t => { document.getElementById(t.menu)?.classList.remove('show'); document.getElementById(t.pill)?.classList.remove('open'); document.getElementById(t.pill)?.setAttribute('aria-expanded', 'false'); }) }
      toggles.forEach(t => {
        const pill = document.getElementById(t.pill), menu = document.getElementById(t.menu);
        if (!pill || !menu) return;
        pill.addEventListener('click', e => { e.stopPropagation(); const open = menu.classList.contains('show'); closeAll(); if (!open) { menu.classList.add('show'); pill.classList.add('open'); pill.setAttribute('aria-expanded', 'true'); } });
        pill.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); pill.click(); } if (e.key === 'Escape') { closeAll(); pill.focus(); } if (e.key === 'ArrowDown') { e.preventDefault(); if (!menu.classList.contains('show')) pill.click(); setTimeout(() => menu.querySelector('a')?.focus(), 120); } });
        menu.addEventListener('click', () => setTimeout(closeAll, 60));
      });
      document.addEventListener('click', e => { if (!['chatPill', 'testPill'].some(id => document.getElementById(id)?.contains(e.target))) closeAll(); });
    })();

  </script>
</body>

</html>